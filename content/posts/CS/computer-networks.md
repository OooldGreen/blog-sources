---
title: "计算机网络" #标题
date: 2022-11-14T15:57:02+08:00 #创建时间
lastmod: 2022-11-28T19:00:00+08:00 #更新时间
categories: ["CS", "课堂笔记"]
tags: ["class note",'computer network']
description: "Computer Network is a MOOC class." #描述
weight: # 输入1可以顶置文章，用来给文章展示排序，不填就默认按时间排序
draft: false # 是否为草稿
# comments: true #是否展示评论
# showToc: true # 显示目录
# TocOpen: true # 自动展开目录
# hidemeta: false # 是否隐藏文章的元信息，如发布日期、作者等
# disableShare: true # 底部不显示分享栏
# showbreadcrumbs: true #顶部显示当前路径
# cover:
#     image: "" #图片路径：posts/tech/文章1/picture.png
#     caption: "" #图片底部描述
#     alt: ""
#    relative: false
---

《计算机网络（自顶向下方法 第7版，James F.Kurose，Keith W.Ross）》 [课程](https://b23.tv/u8AvdXv) 是 2020 年秋科大自动化系本科课程录制版。在介绍计算机网络体系架构的基础上，自上而下、以互联网为例系统地阐述了网络体系结构各层次的主要服务、工作原理、常用技术和协议，包括应用层、传输层、网络层、数据链路层和物理层，最后是网络安全原理和协议。

# 计算机网络和互联网
Internet：是一堆的网络，通过一系列网络交换节点互联互通，向用户提供服务。互联网是分布式的应用进程和提供通信服务的基础设施（应用层以下都是）。

Internet 标准：
- RFC
- IETF

互联网组成：  
- 节点
    - 节点及主机上的应用程序
    - 路由器（网络层）、交换机（链路层）等网络交换设备
- 边
    - access 接入网链路
    - backbone 主干链路
- 协议：根据协议发出请求和接受请求，按照规范解析报文。协议规范了语法、语义、时序、动作四个方面。

互联网的三个子系统：  
- 边缘 (edge) ：存在网络应用和支撑其运行的协议栈
- 核心 (core) ：进行数据交换，是由路由和交换机构成的分布式系统
- 接入 (access)：把边缘接入到网络核心，通过网络核心将数据发送给目标主机，可以有有线或无线通信链路

## 网络边缘 (edge)
### 应用进程之间的通信模式
- 客户端/服务器模式 (CS 模式)
    - 资源在服务器，以服务器为主，服务器支撑，由客户端向服务器请求资源
    - 典型的主从模式
    - 缺点：服务器压力大，服务器通信消耗大，服务器宕机影响大，性能随业务量增加断崖式下降
- 对等 (peer-peer, P2P) 模式
    - 很少（甚至没有）专门的服务器，每个节点既是客户端，又是服务器

### 面向连接的服务
目标是在端系统之间传输数据。需要在数据传输之前做好准备（握手），例如 TCP 协议。

TCP 服务的特性：
- 面相连接
- 可靠的（不重复、不失序、不出错、不丢失）
- 流量控制（协调发送方发送速度和接收方接收速度）
- 拥塞控制（考虑网络路径的通行能力）
- 应用场景：可靠性要求高的应用

UDP（用户数据报）服务的特性：
- 无连接的服务，不需要握手
- 不可靠
- 无流量控制，无拥塞控制
- 快速
- 将端口细分到进程到进程
- 应用场景：实时流媒体，远程会议，域名解析等

## 网络核心 (core)
关键功能有路由和转发

**1. 电路交换** 

端到端的资源被分配给从源端到目标端的呼叫 "call"，为每个呼叫预留一条专有通道进行数据交换。

每条链路被分为若干不同的 pieces，每个呼叫分配独享的链路，资源专用，不共享，这样连接一建立起来就能保证性能，但是会有资源浪费的缺陷，通常被传统电话网络采用，不太适合计算机之间的通信。

将带宽分成片的方法：频分 (FDM)、时分 (TDM)、波分 (WDM)

不适合计算机之间通信的原因：
- 连接建立时间长
- 计算机之间通信有突发性，浪费的片较多（独享链接没有被使用的时候也无法被别的呼叫使用）
- 可靠性不高

**2. 分组交换**

以分组 (package) 为单位，在每一个单位节点经历存储再转发，使用带宽的全部，资源共享，按需使用。

统计多路复用：分组没有固定的模式

数据存储-转发的方式：
- 数据报网络：无连接，每个分组传送是独立的，标识完整的目标主机地址，直接传输。
- 虚电路网络 (virtual circuit)：有连接，先握手，在交换节点之间先建立虚拟的电路，确保网络层的连接，然后每个分组携带虚电路号进行存储转发。虚电路靠信令建立起来。

> 有连接和面向连接：
> - 有连接体现在每一跳的节点上都是有连接的。 
> - 面向连接只体现在发送和接收端连接

优点：
- 支持的用户更多
- 共享性
- 适合突发式的数据传输

缺点：
- 时延是在每个交换节点中存储的时间之和 和 不太确定的排队时延
- 如果路由器缓存用完了，分组将会被抛弃（丢包）
- 过度使用会造成网络拥塞

## 接入网 (access)

1. modem：调制解调器
2. DSL/IDSL：仍然用调制解调的方式，用 4kHz 以上的带宽，分上行和下行链路
3. 线缆网络：有线电缆双向改造，在不同频段传输不同信道的数据，上下行
4. 家庭网络
5. 企业接入网络：直接接到以太网路交换机上

无线接入网络：
- Wlan
- 广域无线接入 (wide-area，蜂窝网络、3G、4G、5G等)
- 无线局域网 WIFI

物理媒体：
- 导引型媒体：有形的
    - 例如同轴电缆（两根同心的铜导线）、光纤（单/多模）、光缆、双绞线
    - 低误码率，双向，高速，安全
- 非导引型媒体：传输电磁波，携带要传输的数据
    - 例如地面微波、LAN、wide-area、卫星等
    - 无需物理“线缆”，双向，有反射、吸收、干扰

---

互联网结构
- 端系统通过接入 ISPs (Internet Service Providers) 连接到互联网，ISP 也要互相连接，但每两个 ISP 互相连接不具有扩展性，可以将每个接入 ISP 都连接到全局 ISP (Global ISP)，客户 ISPs 和提供者 ISPs 有经纪合约
- ISP 之间合作可以完成业务的扩展，对等互联 (peer linking) 的结算关系
- 多个 ISP 接入入互联网交换点 IXP (Internet exchange point)
- 内容提供者 ICP (Internet Content Providers) 费用高，范围有限，需要部署 DC (data center)，通常部署在离 ISP 较近的地方，用专用线缆连在一起

互联网层次结构是松散的：
- 中心：第一层 ISP，国家覆盖，效率极高
- 第二层 ISP：更小些的（通常是区域性的）ISP
- 第三层：Local ISP
- ICP等

ISP 之间的连接：
- POP：高层 ISP 向低层接入，涉及费用结算
- 多宿 (multi home)：低层 ISP 向多个高层 ISP 接入
- IXP：对等连接，通常不涉及费用结算
- ICP自己部署的专用网络，同时和各级 ISP 连接


## 延时、丢失和吞吐量分析
分组延时
1. 节点处理延时  
2. 排队延时  
    根据当时网络情况  
    流量强度 = L*a/R  
    流量强度趋近于 0，排队延时很小；流量强度趋近于 1，延时变得很大，趋近于无穷大；设计系统时流量强度不能大于 1。
3. 传输延时：L/R
4. 传播延时：d/s  

分组丢失：链路的队列缓冲区容量有限，分组到达一个满的队列就会被丢失，丢失的分组可能会被前一个节点或源端系统重传也可能根本不重传

吞吐量：在源端和目标端之间传输的速率（数据量/单位时间）  
瓶颈链路：端到端路径上，限制端到端吞吐的链路  

## 协议层次
把网络复杂的功能分成功能明确的层次，每一层实现一个或一组功能，功能中有其上层能够使用的功能 —— 服务。本层借助层间的接口访问下层提供的服务，通过协议交换信息。

服务 (Service)：低层实体向上层实现提供他们之间通信的能力  
原语 (primitive)：上层使用下层服务的形式  
服务访问点 (SAP, Services Access Point)：使用下层提供的服务通过层间的接口地点

服务和协议的差别和关系：
- 服务：垂直，低层向上层提供的，通过原语操作
- 协议：对等层互相通信的过程中遵循的集合
- 联系：本层协议的实现靠下层提供的服务来实现，本层实体通过协议为上层提供更高级的服务

数据单元 (DU, data unit) SDU 处理：
- 一对一的关系：上层发送了一个数据单元，没有超出分组大小，直接加上 header 成为 n-PDU (protocol data unit)
- 一对多的关系：上层发送的一个数据单元太大了，需要拆解成分组大小  
- 多对一的关系：上层发送很多个非常小的数据单元，下层将数据单元组合成一个分组

分层系统的优缺点：
- 对付复杂的系统
    - 概念化：结构清晰，便于交流和讨论
    - 结构化：模块化易于维护和系统升级
- 子系统相互交换信息降低了效率

### Internet 协议栈
- 应用层：应用报文 (message) 之间的交互，提供网络应用服务
- 传输层：报文段 (message segment)，TCP 段，UDP 数据报，进程到进程的区分，网络层提供的有可能不可靠的服务变成可靠的服务
- 网络层：源主机到目标主机，以分组（packet, 或无连接的方式: 数据报 datagram）为单位的端到端的数据传输，重要任务转发、路由
- 链路层：在相邻两点间传输以帧 (frame) 为单位的数据，交换机
- 物理层：在线路上传输位 (bit)

### ISO/OSI 参考模型
- 应用层
- 表示层：允许应用解释传输的数据，加密、压缩、机器相关的表示转换
- 会话层：建立会话管理，数据交换的同步，检查点，恢复
- 传输层
- 网络层
- 链路层
- 物理层

# 应用层

##  原理
进程通信
进程：在主机上运行的应用程序
- 客户端进程：发起通信的进程
- 服务器进程：等待连接的进程

区分不同的进程：寻址-标识
1. 用IP地址和端口号标识
2. 任何应用进程之间都可以用两个端节点来表示（end point）

### Socket
采用 Socket 减少层间传输的信息量，并且便于管理，实际上是一个**整数**。就像 OS 打开文件返回的句柄一样，对句柄操作就是对文件的操作。

TCP Socket：  
两个进程通信持续一段时间，通信关系稳定，本质是用一个整数表示两个应用实体之间的通信关系，是一个具有本地意义的标示，包括 ——  
四元组：源IP、源端口、目标 IP、目标端口  
传输报文的时候交两样东西：socket 和数据本身

UDP Socket：  
由于不需要建立连接，内容只有二元组：本 IP、本端口，仅代表一个端节点  
传输报文的时候交三样东西：socket、数据本身 和 对方的 IP 和 port

### 应用层协议
运行在不同端系统上的应用进程如何进行交换报文

公开协议：由 RFC  文档定义，允许互操作，如 HTTP、SMTP

私有协议：不公开，如 Skype

###  TCP 和 UDP
都不提供安全性

怎么增加安全性？

安全 TCP：  
- SSL 加密，提供加密的 TCP 连接
- 私密性
- 数据完整性
- 端到端的鉴别

## Web 和 HTTP
Web 页由一些对象组成，，对象可以是 HTML 文件， JPEG 图像，Java 小程序等，通过 URL 对每个对象进行引用。

URL格式：  
协议 - 用户：口令 - 主机名 - 路径名 - 端口

```html
Prot://user:psw@www.someSchool.edu/someDept/pic.gif:port
```

### HTTP

HTTP 即超文本传输协议，是 Web 的应用层协议，使用客户/服务器模式，客户端负责请求、接收和显示 Web 对象（各种浏览器），服务端负责对请求进行相应并发送浏览器（服务器）。  
HTTP 是无状态的，使用 TCP ，客户发起 TCP 连接默认端口号为 80，在浏览器交换 HTTP 报文之后连接关闭。

> 无状态：服务器不需要维护客户端的状态，无记忆  

**往返时间 (RTT, round-trip time)**：一个小的分组从客户端到服务器再回到服务端的时间（字节数很少可以忽略传输时间）  
**响应时间**：包括一个 RTT 发起 TCP 连接，一个 RTT 请求 HTTP 并等待 HTTP 响应 ，文件传输时间（这样一个大的对象传输时间无法忽略）= 2 * RTT + 传输时间

HTTP 请求格式：
- 请求报文格式：请求行、首部行、换行回车符，表示报文结束
    ```
    GET /somedir/page,html HTTP/1.1
    Host: www.someschool.edu
    User-agent: Mozilla/4.0
    Connection: close
    Accept-language: fr  
    （一个额外的换行回车符）
    ```
- 响应报文：状态行（协议版本/状态码/响应状态信息）、首部行、数据（如请求的 HTML 文件）

状态码：
- 200 Ok
- 301 Move Permanently
- 400 Bad Request
- 404 Not Found
- 505 Http Version not Supported


HTTP 1.0 请求方式：
- GET
- POST
- HEAD：要求服务器在响应报文中不包含请求对象 -> 故障跟踪

HTTP 1.1 请求方式；
- GET/POST/HEAD
- PUT：实体主体中的文件上载到 URL 字段规定的路径
- DELETE：删除 URL 字段规定的文件

默认连接方式：流水方式的持久 HTTP 连接，客户端向客户端连接请求，建立连接之后默认不关闭连接。客户端遇到一个引用对象就立即产生一个请求，所有引用对象指花费一个 RTT 是有可能的。

### Cookie
可以使连接有状态的小甜饼～  

1. 在 HTTP 响应报文中有一个 cookie 的首部行
2. 请求报文中含有一个 cookie 的首部行
3. 用户端系统中保留一个 cookie 文件
4. 在 web 站点有一个后端数据库

能做什么呢？举例：
- 用户验证
- 购物车
- 个性化推荐

缺点是隐私性问题，cookie 不够安全，会暴露你的访问行为，被攻击后信息也会暴露

---

Web 缓存：不访问服务器就满足用户的需求，可以降低服务器的负载，降低客户端请求响应时间，通常由 ISP 安装

### FTP
文件传输协议，端口号为 21，客户端通过控制连接（带外传送）完成用户认证，之后可以发出一系列指令传输文件（上载或下载等）

FTP 命令、响应
- USER username
- PASS password
- LIST
- RETER filename
- 311 Username OK, password required

### Email 电子邮件
3个主要组成部分：  
- 用户代理：客户端软件，Outlook，Gmail 等
- 邮件服务器：管理和维护发送给用户的邮件，输出报文队列保持待发送邮件报文
- 简单邮件传输协议：SMTP，使用 TCP 在客户端和服务器之间传送 email 报文，端口号 25，使用持久报文，要求报文为 ASCII 编码

邮件访问协议：  
- POP (Post Office Protocol)：邮局访问协议
- IMAP (Internet Mail Access Protocol)：邮件访问协议，更多特性，在服务器上处理存储的报文
- HTTP：web 访问，文件上载下载，收发邮件

## DNS 域名
DNS (Domain Name System), 应用于其他应用的应用。IP 地址标识主机、路由器，不容易记忆，所以用有意义的字符串来标识地址，由 DNS 负责转换成为二进制的网络地址。DNS 运行在 53 号端口，在边缘系统中实现，主要思路是分层的命名（防止重名）、分布式的数据库。

DNS 目的：  
- 主要目的：完成主机 - IP 地址的转换
- 其他目的有
    - 主机别名到规范名的转换
    - 邮件服务器别名到邮件服务器正规名转换
    - 负载均衡
    
DNS 域名结构：  
- 层次树状结构
- Internet 根被划为几百个顶级域
    - 按国家分: .jp; .cn
    - 按通用的 (genetic): .com; .gov; .edu; .int; .mil; .net; .org; .web ... 
- 每个域下面还可以划分若干个子域
- 树叶是主机

名字服务器：  
- 区域 (zone)：域名，将 DNS 名字空间划分为互不相交的区域，每个区域都是树的一部分
- 每个区域都有一个名字服务器
- 允许被放置在区域之外保障可靠性
- 权威 DNS 服务器：组织机构的 DNS 服务器，提供组织机构服务器可访问的主机和 IP 之间的映射，组织机构可以选择实现自己维护或者某个服务提供商维护
    > TLD 服务器（顶级域服务器）：  负责顶级域名和所有国家顶级域名

### 资源记录 (RR)
区域名字服务器维护的资源记录，RR 格式：(name, value, type, ttl)

内容包括：  
- Domain_name 域名
- TTL (time to live)：生存时间（权威记录/缓冲记录），权威记录 TTL 可以无限大，永久存在
- Class 类别：如果是 Internet，是 IN
- Value 值
- Type 类别

Type:  
- A - name 为主机
- CNAME - name 为规范名字的别名
- NS - name 域名
- MX - name为对应 mail 服务器名字

## P2P 模式应用
Peer to Peer，每个节点既是客户端也是服务端，是**一类应用**

优点：分布式流量，可靠性较高

用例：
- 文件的分发
- 流媒体点播
- VoIP (Skype) 实时音频视频

overlay：客户端配置文件中给出一个列表，记录若干个经常运行的节点的 IP，向这些节点按照协议发出连接报文，在响应中随机选取节点建立起 overlay

非结构化 P2P：覆盖网络 (overlay) 中节点间的关系是随意的  
- 集中化目录
- 完全分布式：限制范围的泛洪 (flooding) 查询，例如 TTL，进行标记
- 混合体：例如 BitTorrent

结构化 (DHT, Distributed Hash Table) P2P：节点间可以构成有序的 overlay（树、环等） 

## CDN (Content Distribution/Delivery Networks)
多媒体流化服务：DASH (Dynamic, Adaptive Streaming over HTTP)

智能客户端：客户端自适应决定 —— 什么时候请求块，请求什么编码速率的视频块，哪里请求块

CDN: 部署缓存节点，存储服务内容，就近为用户提供服务

## Socket 编程
socket：分布式应用进程之间的门，传输层协议提供的端到端服务接口

**TCP 套接字编程**
- 服务器端  
    1. 服务器先运行，创建欢迎 socket
    2. 和本地端口捆绑 bind
    3. 建立 connetionSocket，连接 welcomeSocket，阻塞式等待用户连接
- 客户端 
    4. 客户端创建 clientSocket，隐式绑定（操作系统自动分配）  
    5. 主动和服务端建立连接，connect(ClientSocket, sad)，记录服务器 IP 和端口
- 连接通信  
    6. 服务器端接受连接，返回一个有效值，解除阻塞，建立连接  
    7. 客户端发送请求 send request  
    8. 服务器调用 read 接收，write 回复  
    9. 客户端从服务器读取 read reply  


**UDP Socket 编程**
- 没有握手，服务器和客户端没有连接
- 传送的数据可能乱序也可能丢失
1. 建立 serverSocket
2. bind
3. readfrom，等待客户端发送数据
4. 客户端创建 clientSocket
5. 客户端隐式 bind
6. 客户端 sendto 发送数据
7. 服务端 readfrom 解除阻塞，sendto 返回数据
8. 客户端 read reply from 读取服务端返回的数据
9. 关闭 socket

# 传输层